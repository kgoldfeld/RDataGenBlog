---
title: simstudy updated to version 0.5.0
author: Package Build
date: '2022-07-19'
slug: []
categories: []
tags:
  - R
  - simstudy
  - simulation
type: ''
subtitle: ''
image: ''
draft: true
---

```{r, echo = FALSE}
options(digits = 2)
plotcolors <- c("#B84226", "#1B8445", "#1C5974")

cbbPalette <- c("#B84226","#B88F26", "#A5B435", "#1B8446",
                "#B87326","#B8A526", "#6CA723", "#1C5974") 

ggtheme <- function(panelback = "white") {
  
  ggplot2::theme(
    panel.background = ggplot2::element_rect(fill = panelback),
    panel.grid = ggplot2::element_blank(),
    axis.ticks =  ggplot2::element_line(colour = "black"),
    panel.spacing = ggplot2::unit(0.25, "lines"),  # requires package grid
    panel.border = ggplot2::element_rect(fill = NA, colour="gray90"), 
    plot.title = ggplot2::element_text(size = 8,vjust=.5,hjust=0),
    axis.text = ggplot2::element_text(size=8),
    axis.title = ggplot2::element_text(size = 8)
  )  
  
}
```

A new [version](https://kgoldfeld.github.io/simstudy/index.html){target="_blank"} of `simstudy` is available on [CRAN](https://cran.r-project.org/web/packages/simstudy/index.html){target="_blank"}. There are two major enhancements and several new features. In the "major" category, I would include (1) changes to survival data generation that accommodate hazard ratios that can change over time and competing risks, and (2) the addition of functions to allow users to sample from existing data sets with replacement to generate "synthetic" data will real life distribution properties. Other less monumental, but important, changes were made: updates to functions `genFormula` and `genMarkov`, and two added utility functions, `survGetParams` and `survParamPlot` (described [here](https://kgoldfeld.github.io/simstudy/articles/survival.html){target="_blank"}).

Here are the highlights of the major enhancements:

### Non-proportional hazards

If we want to simulate a scenario where survival time is a function of sex, but the relative risk of death (comparing males to females) changes after 150 days, we could not use a proportional hazards assumption that `simstudy` has typically assumed. Rather, we need to be able to specify different hazards at different time points. This is implemented in `simstudy` by using the `defSurv` function and the `transition` argument. 

In this case, the same outcome variable (in this case "death") is specified multiple times (currently the limit is actually two times) in `defSurv`, and the transition argument indicates the point at which the hazard ratio (HR) changes. In the example below, the log(HR) comparing males and females between day 0 and 150 is -1.4 (HR = 0.25), and after 150 days the hazards are more closely aligned, log(HR) = -0.3 (HR = 0.74). THe data definitions determine the proportion of males in the sample and specify the time to death outcomes:

```{r, message=FALSE}
library(simstudy)
library(survival)
library(gtsummary)
  
def <- defData(varname = "male", formula = 0.5, dist = "binary")

defS <- defSurv(varname = "death", formula = "-14.6 - 1.4 * male", 
  shape = 0.35, transition = 0)
defS <- defSurv(defS, varname = "death", formula = "-14.6 - 0.3 * male", 
  shape = 0.35, transition = 150)
```

If we generate the data and take a look at the survival curves, it is possible to see the slight inflection point at 150 days where the HR shifts:

```{r}
set.seed(10)

dd <- genData(600, def)
dd <- genSurv(dd, defS, digits = 2)
```

```{r, tidy = TRUE, echo = FALSE, fig.width = 6.5, fig.height = 3.5, warning=FALSE}
fit <- survfit( Surv(death) ~ male, data = dd )

survminer::ggsurvplot(fit, data = dd, 
                      ggtheme = ggtheme("grey94"),
                      palette = cbbPalette
)
```

If we fit a standard Cox proportional hazard model and test the proportionality assumption, it is quite clear that the assumption is violated (as the p-value < 0.05).

```{r}
coxfit <- coxph(formula = Surv(death) ~ male, data = dd)
cox.zph(coxfit)
```

If we split the data at the proper inflection point of 150 days, and refit the model, we can recoer the parameters (or at least get pretty close):

```{r}
dd2 <- survSplit(Surv(death) ~ ., data= dd, cut=c(150),
                 episode= "tgroup", id="newid")

coxfit2 <- coxph(Surv(tstart, death, event) ~ male:strata(tgroup), data=dd2)

tbl_regression(coxfit2)
```

The [survival vignette](https://kgoldfeld.github.io/simstudy/articles/survival.html){target="_blank"} has a more detailed description.

### Competing risks

There is a new function called `addCompRisk` that generates a single time to event outcome from a *collection* of time to event outcomes, where the observed outcome is the earliest event. This is done by specifying a *timeName* argument that will represent the observed time value. The event status is indicated in the field set by the *eventName* argument (which defaults to "event"). If a variable name is indicated in the *censorName* argument, the censored events automatically have a value of 0.

To use `addCompRisk`, we first define and generate unique events - in this case *event_1*, *event_2*, and *censor*:

```{r}
set.seed(1)

dS <- defSurv(varname = "event_1", formula = "-10", shape = 0.3)
dS <- defSurv(dS, "event_2", "-6.5", shape = 0.5)
dS <- defSurv(dS, "censor", "-7", shape = 0.55)

dtSurv <- genData(1001)
dtSurv <- genSurv(dtSurv, dS)

dtSurv
```

Now we generate a competing risk outcome "obs_time" and an event indicator "delta":

```{r}
dtSurv <- addCompRisk(dtSurv, events = c("event_1", "event_2", "censor"), 
  eventName = "delta", timeName = "obs_time", censorName = "censor")

dtSurv
```

Here's a plot competing risk data using the cumulative incidence functions (rather than the survival curves):

```{r, tidy = TRUE, echo = FALSE, fig.width = 6.5, fig.height = 3.5, warning=FALSE}
fit <- survfit(Surv(obs_time, delta, type="mstate") ~ 1, data=dtSurv)
survminer::ggcompetingrisks(fit, ggtheme = ggtheme("grey94"))  + 
  ggplot2::scale_fill_manual(values = cbbPalette)
```

The data generation can be done in two (instead of three) steps by including the `timeName` and `eventName` arguments in the call to `genSurv`. In this case, by default the competing events will be all the events defined in `defSurv`:

```{r}
set.seed(1)

dtSurv <- genData(1001)
dtSurv <- genSurv(dtSurv, dS, timeName = "obs_time", 
  eventName = "delta", censorName = "censor")

dtSurv
```

Again, the [survival vignette](https://kgoldfeld.github.io/simstudy/articles/survival.html){target="_blank"} has a more detailed description.

### Synthetic data

Sometimes it is useful to generate data that will represent the distributions of an existing data. Two new functions, `genSynthetic` and `addSynthetic` make it fairly easy to do that.

Let's say we have a data set called $A$ that has fields $a$, $b$, $c$, and $d$:

```{r, echo = FALSE}
d <- defData(varname = "a", formula = 3, variance = 1, dist = "normal")
d <- defData(d, varname = "b", formula = 5, dist = "poisson")
d <- defData(d, varname = "c", formula = 0.3, dist = "binary")
d <- defData(d, varname = "d", formula = "a + b + 3*c", variance = 2, dist = "normal")

A <- genData(1000, d, id = "index")
```

```{r}
A
```

```{r}
summary(A[, 2:5])
```

We can create a synthetic data set by sampling records with replacement from the existing data set $A$:

```{r}
S <- genSynthetic(dtFrom = A, n = 120, id = "index")
S
```

And the distribution of variables in $S$ matches their distribution in $A$:

```{r}
summary(S[, 2:5])
```
