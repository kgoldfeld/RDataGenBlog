---
title: Constrained randomization to evaulate the vaccine rollout in nursing homes
author: Keith Goldfeld
date: '2020-12-22'
slug: []
categories: []
tags:
  - R
type: ''
subtitle: ''
image: ''
output:
  blogdown::html_page:
    anchor_sections: no
draft: true
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>This is a test still.</p>
<pre class="r"><code>library(simstudy)

def &lt;- defData(varname = &quot;network&quot;, formula = &quot;0.3;0.5;0.2&quot;, dist = &quot;categorical&quot;, id = &quot;site&quot;)

defC &lt;- defCondition(condition = &quot;network == 1&quot;, 
  formula = &quot;0.25&quot;, variance = 10, dist = &quot;beta&quot;)
defC &lt;- defCondition(defC, condition = &quot;network == 2&quot;, 
  formula = &quot;0.3&quot;, variance = 7.5, dist = &quot;beta&quot;)
defC &lt;- defCondition(defC, condition = &quot;network == 3&quot;, 
  formula = &quot;0.35&quot;, variance = 5, dist = &quot;beta&quot;)

set.seed(10271)

dd &lt;- genData(200, def, id = &quot;site&quot;)
dd &lt;- addCondition(defC, dd, newvar = &quot;prop&quot;)

dd[, stratum := cut(prop, breaks = c(0, .25, .4, 1), include.lowest = TRUE, labels = c(1, 2, 3))]

dd</code></pre>
<pre><code>##      site  prop network stratum
##   1:    1 0.085       1       1
##   2:    2 0.148       2       1
##   3:    3 0.392       2       2
##   4:    4 0.545       2       3
##   5:    5 0.130       2       1
##  ---                           
## 196:  196 0.341       2       2
## 197:  197 0.221       1       1
## 198:  198 0.541       3       3
## 199:  199 0.053       2       1
## 200:  200 0.398       2       2</code></pre>
<pre class="r"><code>dr &lt;- trtAssign(dd, nTrt = 2, balanced = TRUE, strata = c(&quot;network&quot;, &quot;stratum&quot;), 
                ratio = c(3, 1), grpName = &quot;rx&quot;)
  
dx &lt;- dr[, mean(prop), keyby = c(&quot;network&quot;, &quot;stratum&quot;, &quot;rx&quot;)]
dx &lt;- dcast(dx, network + stratum ~ rx, value.var = &quot;V1&quot;)
dx[, dif := abs(`1` - `0`)]

dx</code></pre>
<pre><code>##    network stratum    0    1    dif
## 1:       1       1 0.15 0.15 0.0022
## 2:       1       2 0.34 0.33 0.0082
## 3:       1       3 0.48 0.47 0.0100
## 4:       2       1 0.15 0.15 0.0018
## 5:       2       2 0.33 0.33 0.0037
## 6:       2       3 0.52 0.48 0.0413
## 7:       3       1 0.14 0.17 0.0364
## 8:       3       2 0.31 0.34 0.0254
## 9:       3       3 0.57 0.45 0.1140</code></pre>
<pre class="r"><code>randomize &lt;- function(dd) {
  
  dr &lt;- trtAssign(dd, nTrt = 2, strata = c(&quot;network&quot;, &quot;stratum&quot;), balanced = TRUE,
                  ratio = c(3, 1), grpName = &quot;rx&quot;)
  
  dx &lt;- dr[, mean(prop), keyby = c(&quot;network&quot;, &quot;stratum&quot;, &quot;rx&quot;)]
  dx &lt;- dcast(dx, network + stratum ~ rx, value.var = &quot;V1&quot;)
  dx[, dif := abs(`1` - `0`)]
  
  list(candidate = all(dx$dif &lt; 0.03), dr = dr[,.(site, rx)])
  
}

candidates &lt;- lapply(1:1000, function(x) randomize(dd))
con_candidates &lt;- candidates[sapply(candidates, function(x) x[[&quot;candidate&quot;]] )]

size &lt;- length(con_candidates)

selected &lt;- con_candidates[[sample(x = size, 1)]][[&quot;dr&quot;]]

ds &lt;- merge(dd, selected, by = &quot;site&quot;)

dx &lt;- ds[, mean(prop), keyby = c(&quot;network&quot;, &quot;stratum&quot;, &quot;rx&quot;)]
dx &lt;- dcast(dx, network + stratum ~ rx, value.var = &quot;V1&quot;)
dx[, dif := abs(`1` - `0`)]

dx</code></pre>
<pre><code>##    network stratum    0    1    dif
## 1:       1       1 0.15 0.17 0.0264
## 2:       1       2 0.33 0.33 0.0038
## 3:       1       3 0.48 0.49 0.0079
## 4:       2       1 0.15 0.15 0.0023
## 5:       2       2 0.32 0.34 0.0187
## 6:       2       3 0.50 0.51 0.0081
## 7:       3       1 0.14 0.15 0.0120
## 8:       3       2 0.32 0.33 0.0124
## 9:       3       3 0.54 0.54 0.0039</code></pre>
