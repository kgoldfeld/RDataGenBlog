---
title: 'A demo: using simulation to estimate power for a cluster randomized trial with a time-to-event outcome'
author: Package Build
date: '2023-05-23'
slug: []
categories: []
tags:
  - R
  - Cluster randomized trials
  - survival analysis
type: ''
subtitle: ''
image: ''
draft: TRUE
---



<pre class="r"><code>library(simstudy)
library(data.table)
library(survival)
library(survminer)
library(coxme)
library(parallel)</code></pre>
<div id="defining-shape-of-survival-curve" class="section level3">
<h3>Defining shape of survival curve</h3>
<pre class="r"><code>points &lt;- list(c(30, 0.90), c(365, .50))
r &lt;- survGetParams(points)
r</code></pre>
<pre><code>## [1] -4.814675  1.326369</code></pre>
<pre class="r"><code>survParamPlot(r[1], r[2], points = points, n = 1000, limits = c(0, 365) )</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
</div>
<div id="evaluating-cluster-variation" class="section level3">
<h3>Evaluating cluster variation</h3>
<div id="visualizing-cluster-variation" class="section level4">
<h4>Visualizing cluster variation</h4>
<pre class="r"><code>defc &lt;- defData(varname = &quot;b&quot;, formula = 0, variance = 0.1)

defa &lt;- defDataAdd(varname = &quot;start_day&quot;, formula = &quot;1;182&quot;, dist = &quot;uniformInt&quot;)
defa &lt;- defDataAdd(defa, varname = &quot;censor&quot;, 
  formula = &quot;365 - start_day &quot;, dist = &quot;nonrandom&quot;)

defs &lt;- defSurv(varname = &quot;ttc&quot;, formula = &quot;r[1] + b&quot;, shape = r[2])</code></pre>
<pre class="r"><code>dc &lt;- genData(20, defc, id = &quot;site&quot;)
dd &lt;- genCluster(dc, &quot;site&quot;, numIndsVar = 200, &quot;id&quot;)
dd &lt;- addColumns(defa, dd)
dd &lt;- genSurv(dd, defs, digits = 0)
dd &lt;- addCompRisk(dd, events = c(&quot;ttc&quot;, &quot;censor&quot;), 
  timeName = &quot;time&quot;, censorName = &quot;censor&quot;, keepEvents = TRUE)</code></pre>
<pre class="r"><code>fit &lt;- survfit(Surv(time, event) ~ site, data = dd)

j &lt;- ggsurvplot(fit, data = dd)
j$plot &lt;- j$plot + 
  theme(legend.position = &quot;none&quot;)

j</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-6-1.png" width="528" /></p>
</div>
<div id="less-cluster-variation" class="section level4">
<h4>Less cluster variation</h4>
<pre class="r"><code>defc &lt;- defData(varname = &quot;b&quot;, formula = 0, variance = 0.005)</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-8-1.png" width="528" /></p>
</div>
<div id="variation-of-the-probability-of-an-event-across-clusters" class="section level4">
<h4>Variation of the probability of an event across clusters</h4>
<pre class="r"><code>defc &lt;- defData(varname = &quot;b&quot;, formula = 0, variance = 0.1)

defa &lt;- defDataAdd(varname = &quot;start_day&quot;, formula = &quot;1;182&quot;, dist = &quot;uniformInt&quot;)
defa &lt;- defDataAdd(defa, varname = &quot;censor&quot;, 
  formula = &quot;365 - start_day &quot;, dist = &quot;nonrandom&quot;)

defs &lt;- defSurv(varname = &quot;ttc&quot;, formula = &quot;r[1] + b&quot;, shape = r[2])

dc &lt;- genData(1000, defc, id = &quot;site&quot;)
dd &lt;- genCluster(dc, &quot;site&quot;, numIndsVar = 500, &quot;id&quot;)
dd &lt;- addColumns(defa, dd)
dd &lt;- genSurv(dd, defs, digits = 0)

dd[, event := 1 * (ttc &lt;= 365)]

ds &lt;- dd[, .(p = mean(event)), keyby = site]

ggplot(data = ds, aes(x = p)) +
  geom_histogram(binwidth = .05) +
  scale_x_continuous(limits = c(0, 1)) +
  scale_y_continuous(limits = c(0, 100)) +
  theme(panel.grid = element_blank())</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-9-1.png" width="384" /></p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-10-1.png" width="384" /></p>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-11-1.png" width="576" /></p>
</div>
</div>
<div id="evaluating-the-effect-size" class="section level3">
<h3>Evaluating the effect size</h3>
<pre class="r"><code>defa &lt;- defData(varname = &quot;rx&quot;, formula = &quot;1;1&quot;, dist = &quot;trtAssign&quot;)
defa &lt;- defData(defa, varname = &quot;start_day&quot;, formula = &quot;1;182&quot;, dist = &quot;uniformInt&quot;)
defa &lt;- defDataAdd(defa, varname = &quot;censor&quot;, 
  formula = &quot;365 - start_day &quot;, dist = &quot;nonrandom&quot;)

defs &lt;- defSurv(varname = &quot;ttc&quot;, formula = &quot;r[1] + 0.4 * rx&quot;, shape = r[2])

set.seed(258)
dd &lt;- genData(600, defa)
dd &lt;- genSurv(dd, defs, digits = 0)
dd &lt;- addCompRisk(dd, events = c(&quot;ttc&quot;, &quot;censor&quot;), 
  timeName = &quot;time&quot;, censorName = &quot;censor&quot;, keepEvents = TRUE)</code></pre>
<pre class="r"><code>fit &lt;- survfit(Surv(time, event) ~ rx, data = dd)

ggsurvplot(
  fit, 
  data = dd, 
  legend.title = &quot;&quot;, 
  legend = c(.25, 0.25),
  palette = &quot;jco&quot;
)</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-13-1.png" width="528" /></p>
</div>
<div id="complete-data-generation-and-model-estimation" class="section level3">
<h3>Complete data generation and model estimation</h3>
<pre class="r"><code>defc &lt;- defData(varname = &quot;b&quot;, formula = 0, variance = 0.05)
defc &lt;- defData(defc, varname = &quot;rx&quot;, formula = &quot;1;1&quot;, dist = &quot;trtAssign&quot;)

defa &lt;- defDataAdd(varname = &quot;start_day&quot;, formula = &quot;1;182&quot;, dist = &quot;uniformInt&quot;)
defa &lt;- defDataAdd(defa, varname = &quot;censor&quot;, 
  formula = &quot;365 - start_day &quot;, dist = &quot;nonrandom&quot;)

defs &lt;- defSurv(varname = &quot;ttc&quot;, formula = &quot;r[1] + 0.4 * rx + b&quot;, shape = r[2])</code></pre>
<pre class="r"><code>dc &lt;- genData(1000, defc, id = &quot;site&quot;)
dd &lt;- genCluster(dc, &quot;site&quot;, numIndsVar = 500, &quot;id&quot;)
dd &lt;- addColumns(defa, dd)
dd &lt;- genSurv(dd, defs, digits = 0)
dd &lt;- addCompRisk(dd, events = c(&quot;ttc&quot;, &quot;censor&quot;), 
  timeName = &quot;time&quot;, censorName = &quot;censor&quot;, keepEvents = TRUE)

fit_coxme &lt;-coxme(Surv(time, event) ~ rx + (1 | site), data = dd)

summary(fit_coxme)</code></pre>
<pre><code>## Cox mixed-effects model fit by maximum likelihood
##   Data: dd
##   events, n = 247347, 5e+05
##   Iterations= 23 96 
##                    NULL Integrated   Fitted
## Log-likelihood -3149149   -3139265 -3137501
## 
##                      Chisq     df p      AIC      BIC
## Integrated loglik 19769.05   2.00 0 19765.05 19744.21
##  Penalized loglik 23296.25 924.84 0 21446.56 11811.03
## 
## Model:  Surv(time, event) ~ rx + (1 | site) 
## Fixed coefficients
##         coef exp(coef)   se(coef)     z p
## rx 0.4039245  1.497691 0.01476242 27.36 0
## 
## Random effects
##  Group Variable  Std Dev   Variance 
##  site  Intercept 0.2272272 0.0516322</code></pre>
<p><a name="addendum"></a></p>
<p>Â </p>
</div>
<div id="power-estimation" class="section level3">
<h3>Power estimation</h3>
<p>Check out the <a href="#addendum">addendum</a> for code details.</p>
<pre class="r"><code>scenario_list &lt;- function(...) {
  argmat &lt;- expand.grid(...)
  return(asplit(argmat, MARGIN = 1))
}

nsites &lt;- c(20, 30)
ninds &lt;- c(15)
s2 &lt;- c(0.03, 0.04)

scenarios &lt;- scenario_list(nsites = nsites, ninds = ninds, s2 = s2)
model.ests &lt;- mclapply(scenarios, function(a) s_scenarios(a, nrep = 3))

model.ests</code></pre>
<pre><code>## [[1]]
##    nsites ninds   s2     est_s     re.var_s    p_s
## 1:     20    15 0.03 0.4206975 8.204975e-05 0.0091
## 2:     20    15 0.03 0.1023435 3.430323e-02 0.5900
## 3:     20    15 0.03 0.4472983 3.898589e-02 0.0110
## 
## [[2]]
##    nsites ninds   s2     est_s     re.var_s    p_s
## 1:     30    15 0.03 0.3175695 0.0725043132 0.0550
## 2:     30    15 0.03 0.5182526 0.0694226028 0.0021
## 3:     30    15 0.03 0.3698889 0.0003995483 0.0074
## 
## [[3]]
##    nsites ninds   s2     est_s   re.var_s   p_s
## 1:     20    15 0.04 0.5033874 0.09028845 0.017
## 2:     20    15 0.04 0.3267158 0.02216258 0.062
## 3:     20    15 0.04 0.3446178 0.03518498 0.055
## 
## [[4]]
##    nsites ninds   s2     est_s     re.var_s    p_s
## 1:     30    15 0.04 0.4506164 8.337081e-05 0.0011
## 2:     30    15 0.04 0.5720621 9.923807e-02 0.0016
## 3:     30    15 0.04 0.4439685 1.490294e-02 0.0027</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-19-1.png" width="768" /></p>
</div>
<div id="addendum" class="section level2">
<h2>Addendum</h2>
<pre class="r"><code>extract_coxme_table &lt;- function (mod) {
  beta &lt;- mod$coefficients 
  nvar &lt;- length(beta)
  nfrail &lt;- nrow(mod$var) - nvar
  se &lt;- sqrt(diag(mod$var)[nfrail + 1:nvar])
  z &lt;- round(beta/se, 2)
  p &lt;- signif(1 - pchisq((beta/se)^2, 1), 2)
  table=data.table(beta = beta, se = se, z = z, p = p)
  return(table)
}

s_def &lt;- function() {
  
  defc &lt;- defData(varname = &quot;b&quot;, formula = 0, variance = &quot;..s2&quot;)
  defc &lt;- defData(defc, varname = &quot;rx&quot;, formula = &quot;1;1&quot;, dist = &quot;trtAssign&quot;)
  
  defa &lt;- defDataAdd(varname = &quot;start_day&quot;, formula = &quot;1;182&quot;, dist = &quot;uniformInt&quot;)
  defa &lt;- defDataAdd(defa, varname = &quot;censor&quot;, 
                     formula = &quot;365 - start_day &quot;, dist = &quot;nonrandom&quot;)
  
  defs &lt;- defSurv(varname = &quot;ttc&quot;, formula = &quot;-4.815 + 0.4 * rx + b&quot;, shape = 1.326)
  
  defa2 &lt;- defDataAdd(varname = &quot;event6&quot;, 
                      formula = &quot;1*(ttc &lt;= 182)&quot;, dist = &quot;nonrandom&quot;)
  
  return(list(defc = defc, defa = defa, defs = defs, defa2 = defa2))
  
}

s_generate &lt;- function(argsvec, list_of_defs) {
  
  list2env(list_of_defs, envir = environment())
  list2env(as.list(argsvec), envir = environment())
  
  dc &lt;- genData(nsites, defc, id = &quot;site&quot;)
  dd &lt;- genCluster(dc, &quot;site&quot;, ninds, &quot;id&quot;)
  dd &lt;- addColumns(defa, dd)
  dd &lt;- genSurv(dd, defs, digits = 0)
  dx &lt;- addCompRisk(dd, events = c(&quot;ttc&quot;, &quot;censor&quot;), 
                    timeName = &quot;time&quot;, censorName = &quot;censor&quot;, keepEvents = TRUE)
  dx &lt;- addColumns(defa2, dx)
  
  dx[]
  
}

s_replicate &lt;- function(argsvec, list_of_defs) {
  
  dx &lt;- s_generate(argsvec, list_of_defs)
  
  coxfitm &lt;-coxme(Surv(time, event) ~ rx + (1 | site), data = dx)
  
  list2env(as.list(argsvec), envir = environment())
  
  return(data.table(
    nsites = nsites,
    ninds = ninds,
    s2 = s2,
    est_s = fixef(coxfitm), 
    re.var_s = VarCorr(coxfitm)$site,
    p_s = extract_coxme_table(coxfitm)$p
  ))
  
}

s_scenarios &lt;- function(argsvec, nreps) {
  
  list_of_defs &lt;- s_def()
  
  rbindlist(
    parallel::mclapply(
      X = 1 : nreps, 
      FUN = function(x) s_replicate(argsvec, list_of_defs), 
      mc.cores = 4)
  )
  
}</code></pre>
</div>
