---
title: 
  'Drawing the wrong conclusion: a comparison of Bayes and frequentist methods'
author: Package Build
date: '2021-09-07'
slug: []
categories: []
tags:
  - Bayesian model
  - Stan
  - R
type: ''
subtitle: ''
image: ''
draft: true
---

<script src="{{< blogdown/postref >}}index.en_files/header-attrs/header-attrs.js"></script>


<pre class="r"><code>library(cmdstanr)
library(simstudy)
library(posterior)
library(data.table)
library(slurmR)

setgrp &lt;- function(a, b, c) {
  
  if (a==0 &amp; b==0 &amp; c==0) return(1)
  if (a==1 &amp; b==0 &amp; c==0) return(2)
  if (a==0 &amp; b==1 &amp; c==0) return(3)
  if (a==0 &amp; b==0 &amp; c==1) return(4)
  if (a==1 &amp; b==1 &amp; c==0) return(5)
  if (a==1 &amp; b==0 &amp; c==1) return(6)
  if (a==0 &amp; b==1 &amp; c==1) return(7)
  if (a==1 &amp; b==1 &amp; c==1) return(8)
  
}

s_define &lt;- function() {
  
  d &lt;- defData(varname = &quot;a&quot;, formula = 0.6, dist=&quot;binary&quot;)
  d &lt;- defData(d, varname = &quot;b&quot;, formula = 0.4, dist=&quot;binary&quot;)
  d &lt;- defData(d, varname = &quot;c&quot;, formula = 0.3, dist=&quot;binary&quot;)
  d &lt;- defData(d, varname = &quot;theta&quot;,
    formula = &quot;..tau[1] + ..tau[2]*a  + ..tau[3]*b + ..tau[4]*c +
               ..tau[5]*a*b + ..tau[6]*a*c + ..tau[7]*b*c + ..tau[8]*a*b*c&quot;,
    dist = &quot;nonrandom&quot;
  )
  
  drx &lt;- defDataAdd(
    varname = &quot;y&quot;, formula = &quot;0 + theta*rx&quot;, 
    variance = 16, 
    dist = &quot;normal&quot;
  )

  return(list(d = d, drx = drx))
  
}

s_generate &lt;- function(n, list_of_defs) {
  
  list2env(list_of_defs, envir = environment())
  
  tau &lt;- rnorm(8, 0, .5)
  
  dd &lt;- genData(n, d)
  dd &lt;- trtAssign(dd, grpName = &quot;rx&quot;)
  dd &lt;- addColumns(drx, dd)
  
  dd[, grp := setgrp(a, b, c), keyby = id]
  
  dd[]
  
}</code></pre>
<pre class="r"><code>set.seed(298372)

defs &lt;- s_define()
s_generate(10, defs)</code></pre>
<pre><code>##     id a b c theta rx     y grp
##  1:  1 0 0 1  0.34  0 -3.45   4
##  2:  2 1 0 1  0.78  1  3.20   6
##  3:  3 0 0 0 -0.28  1  7.29   1
##  4:  4 0 1 0 -0.37  1  2.76   3
##  5:  5 0 0 0 -0.28  0 -0.48   1
##  6:  6 1 0 0 -0.25  0  1.09   2
##  7:  7 0 0 0 -0.28  0 -1.45   1
##  8:  8 0 0 1  0.34  1 -5.78   4
##  9:  9 1 0 0 -0.25  1  2.97   2
## 10: 10 1 0 0 -0.25  0 -1.25   2</code></pre>
<pre class="r"><code>s_model &lt;- function(dd, mod_pool, mod_nopool) {
  ...
}

s_replicate &lt;- function(x, n, mod_pool, mod_nopool) {
  
  set_cmdstan_path(path = &quot;/.../cmdstan/2.25.0&quot;)
  
  defs &lt;- s_define()
  generated_data &lt;- s_generate(n, defs)
  estimates &lt;- s_model(generated_data, mod_pool, mod_nopool)

  estimates[]
}</code></pre>
<pre class="r"><code>set_cmdstan_path(path = &quot;/gpfs/share/apps/cmdstan/2.25.0&quot;)

model_pool &lt;- cmdstan_model(&quot;/.../subs_pool_hpc.stan&quot;)
model_nopool &lt;- cmdstan_model(&quot;/.../subs_nopool_hpc.stan&quot;)

job &lt;- Slurm_lapply(
  X = 1:2500, 
  FUN = s_replicate, 
  n = 150,
  mod_pool = model_pool,
  mod_nopool = model_nopool,
  njobs = 50, 
  mc.cores = 5L,
  job_name = &quot;i_subs&quot;,
  tmp_path = &quot;/.../scratch&quot;,
  plan = &quot;wait&quot;,
  sbatch_opt = list(time = &quot;12:00:00&quot;, partition = &quot;cpu_short&quot;, `mem-per-cpu` = &quot;5G&quot;),
  export = c(&quot;s_define&quot;, &quot;s_generate&quot;, &quot;s_model&quot;),
  overwrite = TRUE
)

job
res &lt;- Slurm_collect(job)

save(res, file = &quot;/.../sub_0.rda&quot;)</code></pre>
<pre><code>##    subgroup pooled unpooled    lm
## 1:    a = 0 0.0012    0.011 0.083
## 2:    a = 1 0.0280    0.039 0.147
## 3:    b = 0 0.0080    0.020 0.106
## 4:    b = 1 0.0244    0.031 0.126
## 5:    c = 0 0.0144    0.028 0.118
## 6:    c = 1 0.0148    0.025 0.100
## 7:  overall 0.0404    0.050 0.158</code></pre>
<pre><code>##    pooled unpooled   lm
## 1:  0.051     0.11 0.37</code></pre>
<p><img src="{{< blogdown/postref >}}index.en_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<p><a href="https://www.rdatagen.net/post/2021-03-16-framework-for-power-analysis-using-simulation/" target="_blank">here</a>
<a href="https://www.rdatagen.net/post/a-frequentist-bayesian-exploring-frequentist-properties-of-bayesian-models/" target="_blank">here</a></p>
