---
title: 
  'Drawing the wrong conclusion: a comparison of Bayes and frequentist methods'
author: Package Build
date: '2021-09-07'
slug: []
categories: []
tags:
  - Bayesian model
  - Stan
  - R
type: ''
subtitle: ''
image: ''
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
options(digits = 2)
```

```{r}
library(cmdstanr)
library(simstudy)
library(posterior)
library(data.table)
library(slurmR)

setgrp <- function(a, b, c) {
  
  if (a==0 & b==0 & c==0) return(1)
  if (a==1 & b==0 & c==0) return(2)
  if (a==0 & b==1 & c==0) return(3)
  if (a==0 & b==0 & c==1) return(4)
  if (a==1 & b==1 & c==0) return(5)
  if (a==1 & b==0 & c==1) return(6)
  if (a==0 & b==1 & c==1) return(7)
  if (a==1 & b==1 & c==1) return(8)
  
}

s_define <- function() {
  
  d <- defData(varname = "a", formula = 0.6, dist="binary")
  d <- defData(d, varname = "b", formula = 0.4, dist="binary")
  d <- defData(d, varname = "c", formula = 0.3, dist="binary")
  d <- defData(d, varname = "theta",
    formula = "..tau[1] + ..tau[2]*a  + ..tau[3]*b + ..tau[4]*c +
               ..tau[5]*a*b + ..tau[6]*a*c + ..tau[7]*b*c + ..tau[8]*a*b*c",
    dist = "nonrandom"
  )
  
  drx <- defDataAdd(
    varname = "y", formula = "0 + theta*rx", 
    variance = 16, 
    dist = "normal"
  )

  return(list(d = d, drx = drx))
  
}

s_generate <- function(n, list_of_defs) {
  
  list2env(list_of_defs, envir = environment())
  
  tau <- rnorm(8, 0, .5)
  
  dd <- genData(n, d)
  dd <- trtAssign(dd, grpName = "rx")
  dd <- addColumns(drx, dd)
  
  dd[, grp := setgrp(a, b, c), keyby = id]
  
  dd[]
  
}
```


```{r}
set.seed(298372)

defs <- s_define()
s_generate(10, defs)
```


```{r, eval=FALSE}
s_model <- function(dd, mod_pool, mod_nopool) {
  ...
}

s_replicate <- function(x, n, mod_pool, mod_nopool) {
  
  set_cmdstan_path(path = "/.../cmdstan/2.25.0")
  
  defs <- s_define()
  generated_data <- s_generate(n, defs)
  estimates <- s_model(generated_data, mod_pool, mod_nopool)

  estimates[]
}
```


```{r, eval = FALSE, echo=TRUE}
set_cmdstan_path(path = "/gpfs/share/apps/cmdstan/2.25.0")

model_pool <- cmdstan_model("/.../subs_pool_hpc.stan")
model_nopool <- cmdstan_model("/.../subs_nopool_hpc.stan")

job <- Slurm_lapply(
  X = 1:2500, 
  FUN = s_replicate, 
  n = 150,
  mod_pool = model_pool,
  mod_nopool = model_nopool,
  njobs = 50, 
  mc.cores = 5L,
  job_name = "i_subs",
  tmp_path = "/.../scratch",
  plan = "wait",
  sbatch_opt = list(time = "12:00:00", partition = "cpu_short", `mem-per-cpu` = "5G"),
  export = c("s_define", "s_generate", "s_model"),
  overwrite = TRUE
)

job
res <- Slurm_collect(job)

save(res, file = "/.../sub_0.rda")
```

```{r, echo = FALSE, fig.width=7}

library(simstudy)
library(data.table)
library(ggplot2)
library(cmdstanr)
library(posterior)

load("data/sub_0.rda")

res <- rbindlist(res)
res[, subgroup := variable]

res[, effect.pool := as.numeric(!between(0, p.025, p.975))]
res[, effect.nopool := as.numeric(!between(0, n.025, n.975))]
res[, effect.lm := as.numeric(!between(0, lm.025, lm.975))]

res[, .(pooled = mean(effect.pool), 
        unpooled = mean(effect.nopool), 
        lm = mean(effect.lm)), 
    keyby = subgroup]

res[, .(sum(effect.pool), 
        sum(effect.nopool),
        sum(effect.lm)), keyby = x][, .(pooled = mean(V1 > 0), 
                                        unpooled = mean(V2 > 0), 
                                        lm = mean(V3 > 0))]

###

cis <- res[, .(index =x, grp = variable, p.025, p.975, n.025, n.975, lm.025, lm.975)]

dp <- melt(data = cis, 
     id.vars = c("index", "grp"),
     measure.vars = list(c("p.025", "n.025", "lm.025"), c("p.975","n.975", "lm.975")), 
     value.name = c("l", "u"),
     variable.factor = TRUE, 
     variable.name = "method"
)

dp[, method := factor(method, labels = c("pooled", "unpooled", "lm"))]

set.seed(8376251)
samp_index <- sample(2500, 80, replace = FALSE)
ds <- dp[index %in% samp_index]
ds[, includes_0 := between(0, l, u)]

ggplot(data= ds, aes(x = l, xend = u, y = factor(index), yend = factor(index))) +
  geom_vline(xintercept = 0, color = "grey85") +
  geom_segment(aes(size = includes_0, color = includes_0)) +
  facet_grid(method ~ grp) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = "none"
  ) +
  scale_color_manual(values = c("#b30003", "grey50")) +
  scale_size_manual(values = c(.25, .1)) +
  xlab("effect size")
```

[here](https://www.rdatagen.net/post/2021-03-16-framework-for-power-analysis-using-simulation/){target="_blank"}
[here](https://www.rdatagen.net/post/a-frequentist-bayesian-exploring-frequentist-properties-of-bayesian-models/){target="_blank"}