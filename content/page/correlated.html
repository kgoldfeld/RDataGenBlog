---
comments: FALSE
---



<div id="correlated-data" class="section level2">
<h2>Correlated data</h2>
<p>Sometimes it is desireable to simulate correlated data from a correlation matrix directly. For example, a simulation might require two random effects (e.g. a random intercept and a random slope). Correlated data like this could be generated using the <code>defData</code> functionality, but it may be more natural to do this with <code>genCorData</code> or <code>addCorData</code>. Currently, simstudy can only generate multivariate normal using these functions. (In the future, additional distributions will be available.)</p>
<p><code>genCorData</code> requires the user to specify a mean vector <code>mu</code>, a single standard deviation or a vector of standard deviations <code>sigma</code>, and either a correlation matrix <code>corMatrix</code> or a correlation coeficient <code>rho</code> and a correlation structure <code>corsrt</code>. It is easy to see how this can be used from a few different examples.</p>
<pre class="r"><code># specifying a specific correlation matrix C
C &lt;- matrix(c(1, 0.7, 0.2, 0.7, 1, 0.8, 0.2, 0.8, 1), nrow = 3)
C</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]  1.0  0.7  0.2
## [2,]  0.7  1.0  0.8
## [3,]  0.2  0.8  1.0</code></pre>
<pre class="r"><code># generate 3 correlated variables with different location and scale for each
# field
dt &lt;- genCorData(1000, mu = c(4, 12, 3), sigma = c(1, 2, 3), corMatrix = C)
dt</code></pre>
<pre><code>##         id       V1        V2         V3
##    1:    1 1.392906  9.443770  2.9383470
##    2:    2 4.065399 10.625822 -0.1819656
##    3:    3 3.163821 10.892218  1.2785671
##    4:    4 3.319071  9.292728 -0.5670356
##    5:    5 4.532852  9.575280 -2.1826324
##   ---                                   
##  996:  996 3.328708  9.092281 -0.5918608
##  997:  997 3.915472 10.022532 -0.8400472
##  998:  998 3.948010 10.529863  1.0872400
##  999:  999 3.103546  8.614582 -2.4100207
## 1000: 1000 4.188079 12.471804  3.2781417</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(V1, V2, V3)), 1)]</code></pre>
<pre><code>##     V1  V2  V3
## V1 1.0 0.7 0.2
## V2 0.7 1.0 0.8
## V3 0.2 0.8 1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(V1, V2, V3)))), 1)]</code></pre>
<pre><code>## V1 V2 V3 
##  1  2  3</code></pre>
<pre class="r"><code># generate 3 correlated variables with different location but same standard
# deviation and compound symmetry (cs) correlation matrix with correlation
# coefficient = 0.4.  Other correlation matrix structures are &#39;independent&#39;
# (&#39;ind&#39;) and &#39;auto-regressive&#39; (&#39;ar1&#39;).

dt &lt;- genCorData(1000, mu = c(4, 12, 3), sigma = 3, rho = 0.4, corstr = &quot;cs&quot;, 
    cnames = c(&quot;x0&quot;, &quot;x1&quot;, &quot;x2&quot;))
dt</code></pre>
<pre><code>##         id         x0        x1         x2
##    1:    1  5.2111338 19.419009  6.1584288
##    2:    2  0.1471494 13.377482  2.8827944
##    3:    3  3.9221373 10.615545  4.1288522
##    4:    4  6.3170779 15.946897  7.6550215
##    5:    5  3.5857382 11.717624  5.6433048
##   ---                                     
##  996:  996  4.1149485 10.407691  5.0661190
##  997:  997  3.8796790  6.886071  6.8446399
##  998:  998  7.2525996  9.291370 -1.4367870
##  999:  999 -0.3571722 11.268489  5.3969855
## 1000: 1000  0.3867660 13.242339  0.7448266</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(x0, x1, x2)), 1)]</code></pre>
<pre><code>##     x0  x1  x2
## x0 1.0 0.4 0.4
## x1 0.4 1.0 0.4
## x2 0.4 0.4 1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(x0, x1, x2)))), 1)]</code></pre>
<pre><code>## x0 x1 x2 
##  3  3  3</code></pre>
<p>The new data generated by <code>genCorData</code> can be merged with an existing data set. Alternatively, <code>addCorData</code> will do this directly:</p>
<pre class="r"><code># define and generate the original data set
def &lt;- defData(varname = &quot;x&quot;, dist = &quot;normal&quot;, formula = 0, variance = 1, id = &quot;cid&quot;)
dt &lt;- genData(1000, def)

# add new correlate fields a0 and a1 to &#39;dt&#39;
dt &lt;- addCorData(dt, idname = &quot;cid&quot;, mu = c(0, 0), sigma = c(2, 0.2), rho = -0.2, 
    corstr = &quot;cs&quot;, cnames = c(&quot;a0&quot;, &quot;a1&quot;))

dt</code></pre>
<pre><code>##        cid           x         a0          a1
##    1:    1  0.06399456 -3.4960079  0.05630022
##    2:    2 -0.51709185 -0.9016526  0.18164584
##    3:    3 -0.66134480 -1.3588746  0.24807037
##    4:    4 -2.18560476  2.2865295 -0.15338170
##    5:    5  0.30794334 -0.1929477  0.12058932
##   ---                                        
##  996:  996  0.56081427  3.2529448 -0.31026090
##  997:  997 -2.00117920  1.4483201 -0.12574743
##  998:  998 -0.07140059 -2.4669752  0.43444749
##  999:  999  1.42508459 -1.5054583  0.16388909
## 1000: 1000 -0.44941696  0.3695881 -0.04216876</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(a0, a1)), 1)]</code></pre>
<pre><code>##      a0   a1
## a0  1.0 -0.2
## a1 -0.2  1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(a0, a1)))), 1)]</code></pre>
<pre><code>##  a0  a1 
## 2.0 0.2</code></pre>
<div id="correlated-data-additional-distributions" class="section level3">
<h3>Correlated data: additional distributions</h3>
<p>Two additional functions facilitiate the generation of correlated data from <em>binomial</em>, <em>poisson</em>, <em>gamma</em>, and <em>uniform</em> distributions: <code>genCorGen</code> and <code>addCorGen</code>.</p>
<p><code>genCorGen</code> is an extension of <code>genCorData</code>. In the first example, we are generating data from a multivariate Poisson distribution. We start by specifying the mean of the Poisson distribution for each new variable, and then we specify the correlation structure, just as we did with the normal distribution.</p>
<pre class="r"><code>l &lt;- c(8, 10, 12) # lambda for each new variable

dx &lt;- genCorGen(1000, nvars = 3, params1 = l, dist = &quot;poisson&quot;, rho = .3, corstr = &quot;cs&quot;, wide = TRUE)
dx</code></pre>
<pre><code>##         id V1 V2 V3
##    1:    1  7 10  5
##    2:    2 15 13 17
##    3:    3  5  7  7
##    4:    4 12  8  9
##    5:    5  9  8 13
##   ---              
##  996:  996  5 14 16
##  997:  997  9 10 11
##  998:  998 12  9 12
##  999:  999 10  6 16
## 1000: 1000  7 11  8</code></pre>
<pre class="r"><code>round(cor(as.matrix(dx[, .(V1, V2, V3)])), 2)</code></pre>
<pre><code>##     V1   V2   V3
## V1 1.0 0.30 0.30
## V2 0.3 1.00 0.26
## V3 0.3 0.26 1.00</code></pre>
<p>We can also generate correlated binary data by specifying the probabilities:</p>
<pre class="r"><code>genCorGen(1000, nvars = 3, params1 = c(.3, .5, .7), dist = &quot;binary&quot;, rho = .8, corstr = &quot;cs&quot;, wide = TRUE)</code></pre>
<pre><code>##         id V1 V2 V3
##    1:    1  0  0  1
##    2:    2  0  0  0
##    3:    3  1  1  1
##    4:    4  0  0  0
##    5:    5  0  0  1
##   ---              
##  996:  996  0  1  0
##  997:  997  0  1  1
##  998:  998  0  0  0
##  999:  999  0  0  1
## 1000: 1000  1  1  1</code></pre>
<p>The gamma distribution requires two parameters - the mean and dispersion. (These are converted into shape and rate parameters more commonly used.)</p>
<pre class="r"><code>dx &lt;- genCorGen(1000, nvars = 3, params1 = l, params2 = c(1,1,1), dist = &quot;gamma&quot;, rho = .7, corstr = &quot;cs&quot;, wide = TRUE, cnames=&quot;a, b, c&quot;)
dx</code></pre>
<pre><code>##         id         a          b         c
##    1:    1  7.050571  5.0530379  2.748646
##    2:    2  3.700817  3.1711222  2.366678
##    3:    3 10.374349 19.6442053  3.558360
##    4:    4 13.330480 22.3109536 22.393015
##    5:    5 11.627826  5.3546691 23.496093
##   ---                                    
##  996:  996  4.774309  4.5677187  4.651620
##  997:  997  7.689480  0.8803929  8.698631
##  998:  998  8.756713  9.9632773 13.283517
##  999:  999  5.481623  8.0257106 14.378901
## 1000: 1000 10.798943 23.9011755 20.547054</code></pre>
<pre class="r"><code>round(cor(as.matrix(dx[, .(a, b, c)])), 2)</code></pre>
<pre><code>##      a    b    c
## a 1.00 0.65 0.65
## b 0.65 1.00 0.62
## c 0.65 0.62 1.00</code></pre>
<p>These data sets can be generated in either <em>wide</em> or <em>long</em> form. So far, we have generated <em>wide</em> form data, where there is one row per unique id. Now, we will generate data using the <em>long</em> form, where the correlated data are on different rows, so that there are repeated measurements for each id. An id will have multiple records (i.e. one id will appear on multiple rows):</p>
<pre class="r"><code>dx &lt;- genCorGen(1000, nvars = 3, params1 = l, params2 = c(1,1,1), dist = &quot;gamma&quot;, rho = .7, corstr = &quot;cs&quot;, wide = FALSE, cnames=&quot;NewCol&quot;)
dx</code></pre>
<pre><code>##         id period    NewCol
##    1:    1      0  4.371804
##    2:    1      1  8.073348
##    3:    1      2 11.434771
##    4:    2      0  5.108602
##    5:    2      1  3.100561
##   ---                      
## 2996:  999      1  6.327056
## 2997:  999      2  8.660597
## 2998: 1000      0  6.229901
## 2999: 1000      1 15.594424
## 3000: 1000      2 19.666630</code></pre>
<p><code>addCorGen</code> allows us to create correlated data from an existing data set, as one can already do using <code>addCorData</code>. In the case of <code>addCorGen</code>, the parameter(s) used to define the distribution are created as a field (or fields) in the dataset. The correlated data are added to the existing data set. In the example below, we are going to generate three sets (poisson, binary, and gamma) of correlated data with means that are a function of the variable <code>xbase</code>, which varies by id.</p>
<p>First we define the data and generate a data set:</p>
<pre class="r"><code>def &lt;- defData(varname = &quot;xbase&quot;, formula = 5, variance = .2, dist = &quot;gamma&quot;, id = &quot;cid&quot;)
def &lt;- defData(def, varname = &quot;lambda&quot;, formula = &quot;.5 + .1*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)
def &lt;- defData(def, varname = &quot;p&quot;, formula = &quot;-2 + .3*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;logit&quot;)
def &lt;- defData(def, varname = &quot;gammaMu&quot;, formula = &quot;.5 + .2*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)
def &lt;- defData(def, varname = &quot;gammaDis&quot;, formula = 1, dist=&quot;nonrandom&quot;)

dt &lt;- genData(10000, def)
dt</code></pre>
<pre><code>##          cid    xbase   lambda         p   gammaMu gammaDis
##     1:     1 2.718390 2.163742 0.2342471  2.839642        1
##     2:     2 6.804114 3.255713 0.5103071  6.429025        1
##     3:     3 4.230530 2.516963 0.3250102  3.842434        1
##     4:     4 4.284853 2.530673 0.3285956  3.884408        1
##     5:     5 4.452418 2.573436 0.3397800  4.016792        1
##    ---                                                     
##  9996:  9996 5.140406 2.756717 0.3874893  4.609324        1
##  9997:  9997 4.905964 2.692840 0.3709343  4.398188        1
##  9998:  9998 4.282280 2.530022 0.3284253  3.882410        1
##  9999:  9999 9.804917 4.395106 0.7193975 11.716327        1
## 10000: 10000 1.780496 1.970032 0.1875740  2.353960        1</code></pre>
<p>The Poisson distribution has a single paramter, lambda:</p>
<pre class="r"><code>dtX1 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 3, rho = .1, corstr = &quot;cs&quot;,
                    dist = &quot;poisson&quot;, param1 = &quot;lambda&quot;, cnames = &quot;a, b, c&quot;)
dtX1</code></pre>
<pre><code>##          cid    xbase   lambda         p   gammaMu gammaDis a b c
##     1:     1 2.718390 2.163742 0.2342471  2.839642        1 2 0 0
##     2:     2 6.804114 3.255713 0.5103071  6.429025        1 7 3 3
##     3:     3 4.230530 2.516963 0.3250102  3.842434        1 2 4 3
##     4:     4 4.284853 2.530673 0.3285956  3.884408        1 1 0 1
##     5:     5 4.452418 2.573436 0.3397800  4.016792        1 1 0 1
##    ---                                                           
##  9996:  9996 5.140406 2.756717 0.3874893  4.609324        1 6 2 1
##  9997:  9997 4.905964 2.692840 0.3709343  4.398188        1 4 4 1
##  9998:  9998 4.282280 2.530022 0.3284253  3.882410        1 1 1 3
##  9999:  9999 9.804917 4.395106 0.7193975 11.716327        1 5 8 6
## 10000: 10000 1.780496 1.970032 0.1875740  2.353960        1 1 3 1</code></pre>
<p>The Bernouilli (binary) distribution has a single parameter, p:</p>
<pre class="r"><code>dtX2 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 4, rho = .4, corstr = &quot;ar1&quot;,
                    dist = &quot;binary&quot;, param1 = &quot;p&quot;)
dtX2</code></pre>
<pre><code>##          cid    xbase   lambda         p   gammaMu gammaDis V1 V2 V3 V4
##     1:     1 2.718390 2.163742 0.2342471  2.839642        1  0  0  0  0
##     2:     2 6.804114 3.255713 0.5103071  6.429025        1  0  0  1  1
##     3:     3 4.230530 2.516963 0.3250102  3.842434        1  1  1  0  0
##     4:     4 4.284853 2.530673 0.3285956  3.884408        1  1  1  0  1
##     5:     5 4.452418 2.573436 0.3397800  4.016792        1  1  0  1  0
##    ---                                                                 
##  9996:  9996 5.140406 2.756717 0.3874893  4.609324        1  0  1  0  0
##  9997:  9997 4.905964 2.692840 0.3709343  4.398188        1  1  0  0  0
##  9998:  9998 4.282280 2.530022 0.3284253  3.882410        1  1  1  0  1
##  9999:  9999 9.804917 4.395106 0.7193975 11.716327        1  0  1  1  1
## 10000: 10000 1.780496 1.970032 0.1875740  2.353960        1  0  0  0  0</code></pre>
<p>The Gamma distribution has two parameters - in <code>simstudy</code> the mean and dispersion are specified:</p>
<pre class="r"><code>dtX3 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 4, rho = .4, corstr = &quot;cs&quot;,
                  dist = &quot;gamma&quot;, param1 = &quot;gammaMu&quot;, param2 = &quot;gammaDis&quot;)
dtX3</code></pre>
<pre><code>##          cid    xbase   lambda         p   gammaMu gammaDis         V1
##     1:     1 2.718390 2.163742 0.2342471  2.839642        1  1.2696202
##     2:     2 6.804114 3.255713 0.5103071  6.429025        1  2.4570714
##     3:     3 4.230530 2.516963 0.3250102  3.842434        1  4.6878484
##     4:     4 4.284853 2.530673 0.3285956  3.884408        1 11.1944562
##     5:     5 4.452418 2.573436 0.3397800  4.016792        1 12.7515202
##    ---                                                                
##  9996:  9996 5.140406 2.756717 0.3874893  4.609324        1  2.9212280
##  9997:  9997 4.905964 2.692840 0.3709343  4.398188        1  4.1773350
##  9998:  9998 4.282280 2.530022 0.3284253  3.882410        1  2.5666382
##  9999:  9999 9.804917 4.395106 0.7193975 11.716327        1 21.9827960
## 10000: 10000 1.780496 1.970032 0.1875740  2.353960        1  0.4030726
##                V2         V3        V4
##     1:  1.3827728  0.2044282 0.7716210
##     2:  3.6792540  0.5091318 1.5140350
##     3:  9.5211949  8.9317722 2.7042206
##     4: 10.9864779  8.2817944 6.0611698
##     5:  2.8191357  5.3065266 4.8157694
##    ---                                
##  9996:  2.9647953 11.8517018 8.9424248
##  9997:  0.1148318  0.9824458 3.7632139
##  9998:  1.0069876  1.8939561 3.2347573
##  9999:  1.4449182 12.7938156 4.4306494
## 10000:  0.3818592  0.9439542 0.8119473</code></pre>
<p>If we have data in <em>long</em> form (e.g. longitudinal data), the function will recognize the structure:</p>
<pre class="r"><code>def &lt;- defData(varname = &quot;xbase&quot;, formula = 5, variance = .4, dist = &quot;gamma&quot;, id = &quot;cid&quot;)
def &lt;- defData(def, &quot;nperiods&quot;, formula = 3, dist = &quot;noZeroPoisson&quot;)

def2 &lt;- defDataAdd(varname = &quot;lambda&quot;, formula = &quot;.5+.5*period + .1*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)

dt &lt;- genData(1000, def)

dtLong &lt;- addPeriods(dt, idvars = &quot;cid&quot;, nPeriods = 3)
dtLong &lt;- addColumns(def2, dtLong)

dtLong</code></pre>
<pre><code>##        cid period    xbase nperiods timeID   lambda
##    1:    1      0 7.896217        5      1 3.631413
##    2:    1      1 7.896217        5      2 5.987187
##    3:    1      2 7.896217        5      3 9.871203
##    4:    2      0 1.683553        7      4 1.951026
##    5:    2      1 1.683553        7      5 3.216698
##   ---                                              
## 2996:  999      1 3.239378        4   2996 3.758191
## 2997:  999      2 3.239378        4   2997 6.196210
## 2998: 1000      0 3.050704        4   2998 2.236854
## 2999: 1000      1 3.050704        4   2999 3.687949
## 3000: 1000      2 3.050704        4   3000 6.080399</code></pre>
<pre class="r"><code>### Generate the data 

dtX3 &lt;- addCorGen(dtOld = dtLong, idvar = &quot;cid&quot;, nvars = 3, rho = .6, corstr = &quot;cs&quot;,
                  dist = &quot;poisson&quot;, param1 = &quot;lambda&quot;, cnames = &quot;NewPois&quot;)
dtX3</code></pre>
<pre><code>##        cid period    xbase nperiods timeID   lambda NewPois
##    1:    1      0 7.896217        5      1 3.631413       3
##    2:    1      1 7.896217        5      2 5.987187       7
##    3:    1      2 7.896217        5      3 9.871203      15
##    4:    2      0 1.683553        7      4 1.951026       2
##    5:    2      1 1.683553        7      5 3.216698       3
##   ---                                                      
## 2996:  999      1 3.239378        4   2996 3.758191       2
## 2997:  999      2 3.239378        4   2997 6.196210       6
## 2998: 1000      0 3.050704        4   2998 2.236854       2
## 2999: 1000      1 3.050704        4   2999 3.687949       6
## 3000: 1000      2 3.050704        4   3000 6.080399       9</code></pre>
<p>We can fit a generalized estimating equation (GEE) model and examine the coefficients and the working correlation matrix. They match closely to the data generating parameters:</p>
<pre class="r"><code>geefit &lt;- gee(NewPois ~ period + xbase, data = dtX3, id = cid, family = poisson, corstr = &quot;exchangeable&quot;)</code></pre>
<pre><code>## Beginning Cgee S-function, @(#) geeformula.q 4.13 98/01/27</code></pre>
<pre><code>## running glm to get initial regression estimate</code></pre>
<pre><code>## (Intercept)      period       xbase 
##  0.50671070  0.49874292  0.09839133</code></pre>
<pre class="r"><code>round(summary(geefit)$working.correlation, 2)</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,] 1.00 0.57 0.57
## [2,] 0.57 1.00 0.57
## [3,] 0.57 0.57 1.00</code></pre>
</div>
</div>
