---
comments: FALSE
---



<div id="correlated-data" class="section level2">
<h2>Correlated data</h2>
<p>Sometimes it is desireable to simulate correlated data from a correlation matrix directly. For example, a simulation might require two random effects (e.g. a random intercept and a random slope). Correlated data like this could be generated using the <code>defData</code> functionality, but it may be more natural to do this with <code>genCorData</code> or <code>addCorData</code>. Currently, simstudy can only generate multivariate normal using these functions. (In the future, additional distributions will be available.)</p>
<p><code>genCorData</code> requires the user to specify a mean vector <code>mu</code>, a single standard deviation or a vector of standard deviations <code>sigma</code>, and either a correlation matrix <code>corMatrix</code> or a correlation coeficient <code>rho</code> and a correlation structure <code>corsrt</code>. It is easy to see how this can be used from a few different examples.</p>
<pre class="r"><code># specifying a specific correlation matrix C
C &lt;- matrix(c(1, 0.7, 0.2, 0.7, 1, 0.8, 0.2, 0.8, 1), nrow = 3)
C</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]  1.0  0.7  0.2
## [2,]  0.7  1.0  0.8
## [3,]  0.2  0.8  1.0</code></pre>
<pre class="r"><code># generate 3 correlated variables with different location and scale for each
# field
dt &lt;- genCorData(1000, mu = c(4, 12, 3), sigma = c(1, 2, 3), corMatrix = C)
dt</code></pre>
<pre><code>##         id       V1        V2        V3
##    1:    1 5.175198 13.475304 5.1295560
##    2:    2 6.148122 14.559390 4.1699518
##    3:    3 3.506949 11.230037 2.5261382
##    4:    4 4.749771 10.763932 0.2532738
##    5:    5 4.015387 10.566282 0.2957012
##   ---                                  
##  996:  996 4.808030 14.343048 5.8301808
##  997:  997 5.062691 12.832404 1.9779340
##  998:  998 4.415287 11.906988 3.4244524
##  999:  999 3.894458 11.302808 0.6765230
## 1000: 1000 3.119236  9.877955 0.1391898</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(V1, V2, V3)), 1)]</code></pre>
<pre><code>##     V1  V2  V3
## V1 1.0 0.7 0.3
## V2 0.7 1.0 0.8
## V3 0.3 0.8 1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(V1, V2, V3)))), 1)]</code></pre>
<pre><code>##  V1  V2  V3 
## 1.0 2.1 3.0</code></pre>
<pre class="r"><code># generate 3 correlated variables with different location but same standard
# deviation and compound symmetry (cs) correlation matrix with correlation
# coefficient = 0.4.  Other correlation matrix structures are &#39;independent&#39;
# (&#39;ind&#39;) and &#39;auto-regressive&#39; (&#39;ar1&#39;).

dt &lt;- genCorData(1000, mu = c(4, 12, 3), sigma = 3, rho = 0.4, corstr = &quot;cs&quot;, 
    cnames = c(&quot;x0&quot;, &quot;x1&quot;, &quot;x2&quot;))
dt</code></pre>
<pre><code>##         id        x0        x1          x2
##    1:    1 5.1704538 14.736222  4.09747031
##    2:    2 7.2459091 12.153271  5.50954378
##    3:    3 3.4494976  7.530484  1.65814731
##    4:    4 4.6032947 13.665794  0.07870362
##    5:    5 7.0539295 15.566933 -0.10698710
##   ---                                     
##  996:  996 6.7887273 14.644606  3.69722472
##  997:  997 0.1168064 13.848031  1.67286050
##  998:  998 1.4102270 16.518551  2.27294549
##  999:  999 8.1437522 12.489765  5.15217852
## 1000: 1000 6.0946875 13.771594  6.76151462</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(x0, x1, x2)), 1)]</code></pre>
<pre><code>##     x0  x1  x2
## x0 1.0 0.4 0.4
## x1 0.4 1.0 0.5
## x2 0.4 0.5 1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(x0, x1, x2)))), 1)]</code></pre>
<pre><code>## x0 x1 x2 
##  3  3  3</code></pre>
<p>The new data generated by <code>genCorData</code> can be merged with an existing data set. Alternatively, <code>addCorData</code> will do this directly:</p>
<pre class="r"><code># define and generate the original data set
def &lt;- defData(varname = &quot;x&quot;, dist = &quot;normal&quot;, formula = 0, variance = 1, id = &quot;cid&quot;)
dt &lt;- genData(1000, def)

# add new correlate fields a0 and a1 to &#39;dt&#39;
dt &lt;- addCorData(dt, idname = &quot;cid&quot;, mu = c(0, 0), sigma = c(2, 0.2), rho = -0.2, 
    corstr = &quot;cs&quot;, cnames = c(&quot;a0&quot;, &quot;a1&quot;))

dt</code></pre>
<pre><code>##        cid          x          a0          a1
##    1:    1 -2.0002005  1.23142587 -0.15591008
##    2:    2  1.3068252  3.35030794  0.04473544
##    3:    3 -2.4373796 -0.04379933 -0.06749237
##    4:    4  0.6510882  2.72643295 -0.20067756
##    5:    5 -1.2058478 -1.29847370  0.09098883
##   ---                                        
##  996:  996  1.6253540 -0.76489427  0.25641838
##  997:  997 -0.1449566  2.24128795 -0.35765744
##  998:  998 -1.7237100  0.44371132  0.07146061
##  999:  999  1.7049417  0.72965233 -0.20317857
## 1000: 1000 -0.2874821 -2.62592980  0.05684503</code></pre>
<pre class="r"><code># estimate correlation matrix
dt[, round(cor(cbind(a0, a1)), 1)]</code></pre>
<pre><code>##      a0   a1
## a0  1.0 -0.2
## a1 -0.2  1.0</code></pre>
<pre class="r"><code># estimate standard deviation
dt[, round(sqrt(diag(var(cbind(a0, a1)))), 1)]</code></pre>
<pre><code>##  a0  a1 
## 1.9 0.2</code></pre>
<div id="correlated-data-additional-distributions" class="section level3">
<h3>Correlated data: additional distributions</h3>
<p>Two additional functions facilitiate the generation of correlated data from <em>binomial</em>, <em>poisson</em>, <em>gamma</em>, and <em>uniform</em> distributions: <code>genCorGen</code> and <code>addCorGen</code>.</p>
<p><code>genCorGen</code> is an extension of <code>genCorData</code>. In the first example, we are generating data from a multivariate Poisson distribution. We start by specifying the mean of the Poisson distribution for each new variable, and then we specify the correlation structure, just as we did with the normal distribution.</p>
<pre class="r"><code>l &lt;- c(8, 10, 12) # lambda for each new variable

dx &lt;- genCorGen(1000, nvars = 3, params1 = l, dist = &quot;poisson&quot;, rho = .3, corstr = &quot;cs&quot;, wide = TRUE)
dx</code></pre>
<pre><code>##         id V1 V2 V3
##    1:    1 11  8 14
##    2:    2  9  7  8
##    3:    3 10  6 10
##    4:    4  7 12  7
##    5:    5  8 12  6
##   ---              
##  996:  996  9 10 17
##  997:  997  5 12 14
##  998:  998 12  7 17
##  999:  999  8 10 18
## 1000: 1000 11  8 14</code></pre>
<pre class="r"><code>round(cor(as.matrix(dx[, .(V1, V2, V3)])), 2)</code></pre>
<pre><code>##     V1   V2   V3
## V1 1.0 0.30 0.30
## V2 0.3 1.00 0.28
## V3 0.3 0.28 1.00</code></pre>
<p>We can also generate correlated binary data by specifying the probabilities:</p>
<pre class="r"><code>genCorGen(1000, nvars = 3, params1 = c(.3, .5, .7), dist = &quot;binary&quot;, rho = .8, corstr = &quot;cs&quot;, wide = TRUE)</code></pre>
<pre><code>##         id V1 V2 V3
##    1:    1  0  1  1
##    2:    2  0  0  0
##    3:    3  1  1  1
##    4:    4  1  1  1
##    5:    5  1  1  1
##   ---              
##  996:  996  1  1  1
##  997:  997  0  0  0
##  998:  998  0  0  0
##  999:  999  0  1  1
## 1000: 1000  1  1  1</code></pre>
<p>The gamma distribution requires two parameters - the mean and dispersion. (These are converted into shape and rate parameters more commonly used.)</p>
<pre class="r"><code>dx &lt;- genCorGen(1000, nvars = 3, params1 = l, params2 = c(1,1,1), dist = &quot;gamma&quot;, rho = .7, corstr = &quot;cs&quot;, wide = TRUE, cnames=&quot;a, b, c&quot;)
dx</code></pre>
<pre><code>##         id          a         b         c
##    1:    1  4.0176528  3.300775 10.947061
##    2:    2  5.7971263  2.404389  9.075953
##    3:    3  0.1486053  1.652021  1.345433
##    4:    4  9.3547511  3.895941 16.519604
##    5:    5 26.8428068 17.580896 42.576020
##   ---                                    
##  996:  996  6.5632697 17.244106 10.174170
##  997:  997  1.8017182  4.138351  4.957164
##  998:  998  2.8456901  1.244327  1.329657
##  999:  999 18.8241532  8.119347 28.246069
## 1000: 1000 14.4171944 13.680144 11.783173</code></pre>
<pre class="r"><code>round(cor(as.matrix(dx[, .(a, b, c)])), 2)</code></pre>
<pre><code>##      a    b    c
## a 1.00 0.63 0.66
## b 0.63 1.00 0.67
## c 0.66 0.67 1.00</code></pre>
<p>These data sets can be generated in either <em>wide</em> or <em>long</em> form. So far, we have generated <em>wide</em> form data, where there is one row per unique id. Now, we will generate data using the <em>long</em> form, where the correlated data are on different rows, so that there are repeated measurements for each id. An id will have multiple records (i.e. one id will appear on multiple rows):</p>
<pre class="r"><code>dx &lt;- genCorGen(1000, nvars = 3, params1 = l, params2 = c(1,1,1), dist = &quot;gamma&quot;, rho = .7, corstr = &quot;cs&quot;, wide = FALSE, cnames=&quot;NewCol&quot;)
dx</code></pre>
<pre><code>##         id period    NewCol
##    1:    1      0  0.342141
##    2:    1      1  1.535126
##    3:    1      2  3.309982
##    4:    2      0 10.669610
##    5:    2      1 15.033243
##   ---                      
## 2996:  999      1  9.848735
## 2997:  999      2 19.179119
## 2998: 1000      0 21.099791
## 2999: 1000      1 23.534390
## 3000: 1000      2 14.600664</code></pre>
<p><code>addCorGen</code> allows us to create correlated data from an existing data set, as one can already do using <code>addCorData</code>. In the case of <code>addCorGen</code>, the parameter(s) used to define the distribution are created as a field (or fields) in the dataset. The correlated data are added to the existing data set. In the example below, we are going to generate three sets (poisson, binary, and gamma) of correlated data with means that are a function of the variable <code>xbase</code>, which varies by id.</p>
<p>First we define the data and generate a data set:</p>
<pre class="r"><code>def &lt;- defData(varname = &quot;xbase&quot;, formula = 5, variance = .2, dist = &quot;gamma&quot;, id = &quot;cid&quot;)
def &lt;- defData(def, varname = &quot;lambda&quot;, formula = &quot;.5 + .1*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)
def &lt;- defData(def, varname = &quot;p&quot;, formula = &quot;-2 + .3*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;logit&quot;)
def &lt;- defData(def, varname = &quot;gammaMu&quot;, formula = &quot;.5 + .2*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)
def &lt;- defData(def, varname = &quot;gammaDis&quot;, formula = 1, dist=&quot;nonrandom&quot;)

dt &lt;- genData(10000, def)
dt</code></pre>
<pre><code>##          cid      xbase   lambda         p   gammaMu gammaDis
##     1:     1  3.5795510 2.358333 0.2837096  3.373363        1
##     2:     2  2.4815923 2.113107 0.2217457  2.708293        1
##     3:     3  3.6814643 2.382491 0.2899636  3.442827        1
##     4:     4  5.5136005 2.861540 0.4143722  4.966523        1
##     5:     5  0.6139601 1.753118 0.1399372  1.864125        1
##    ---                                                       
##  9996:  9996  8.0718982 3.695773 0.6038587  8.284445        1
##  9997:  9997  5.1469824 2.758531 0.3879577  4.615391        1
##  9998:  9998 11.5464949 5.231246 0.8121358 16.598278        1
##  9999:  9999  1.5727854 1.929534 0.1782624  2.258175        1
## 10000: 10000  4.9227111 2.697354 0.3721074  4.412945        1</code></pre>
<p>The Poisson distribution has a single paramter, lambda:</p>
<pre class="r"><code>dtX1 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 3, rho = .1, corstr = &quot;cs&quot;,
                    dist = &quot;poisson&quot;, param1 = &quot;lambda&quot;, cnames = &quot;a, b, c&quot;)
dtX1</code></pre>
<pre><code>##          cid      xbase   lambda         p   gammaMu gammaDis a b c
##     1:     1  3.5795510 2.358333 0.2837096  3.373363        1 1 2 1
##     2:     2  2.4815923 2.113107 0.2217457  2.708293        1 1 0 3
##     3:     3  3.6814643 2.382491 0.2899636  3.442827        1 3 3 3
##     4:     4  5.5136005 2.861540 0.4143722  4.966523        1 6 2 5
##     5:     5  0.6139601 1.753118 0.1399372  1.864125        1 3 3 2
##    ---                                                             
##  9996:  9996  8.0718982 3.695773 0.6038587  8.284445        1 5 7 5
##  9997:  9997  5.1469824 2.758531 0.3879577  4.615391        1 0 1 6
##  9998:  9998 11.5464949 5.231246 0.8121358 16.598278        1 3 7 3
##  9999:  9999  1.5727854 1.929534 0.1782624  2.258175        1 1 1 2
## 10000: 10000  4.9227111 2.697354 0.3721074  4.412945        1 2 4 1</code></pre>
<p>The Bernouilli (binary) distribution has a single parameter, p:</p>
<pre class="r"><code>dtX2 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 4, rho = .4, corstr = &quot;ar1&quot;,
                    dist = &quot;binary&quot;, param1 = &quot;p&quot;)
dtX2</code></pre>
<pre><code>##          cid      xbase   lambda         p   gammaMu gammaDis V1 V2 V3 V4
##     1:     1  3.5795510 2.358333 0.2837096  3.373363        1  0  0  0  1
##     2:     2  2.4815923 2.113107 0.2217457  2.708293        1  0  0  0  0
##     3:     3  3.6814643 2.382491 0.2899636  3.442827        1  0  1  1  0
##     4:     4  5.5136005 2.861540 0.4143722  4.966523        1  1  0  0  0
##     5:     5  0.6139601 1.753118 0.1399372  1.864125        1  0  1  0  0
##    ---                                                                   
##  9996:  9996  8.0718982 3.695773 0.6038587  8.284445        1  1  1  0  0
##  9997:  9997  5.1469824 2.758531 0.3879577  4.615391        1  0  0  0  1
##  9998:  9998 11.5464949 5.231246 0.8121358 16.598278        1  1  1  1  0
##  9999:  9999  1.5727854 1.929534 0.1782624  2.258175        1  0  0  0  0
## 10000: 10000  4.9227111 2.697354 0.3721074  4.412945        1  0  0  0  1</code></pre>
<p>The Gamma distribution has two parameters - in <code>simstudy</code> the mean and dispersion are specified:</p>
<pre class="r"><code>dtX3 &lt;- addCorGen(dtOld = dt, idvar = &quot;cid&quot;, nvars = 4, rho = .4, corstr = &quot;cs&quot;,
                  dist = &quot;gamma&quot;, param1 = &quot;gammaMu&quot;, param2 = &quot;gammaDis&quot;)
dtX3</code></pre>
<pre><code>##          cid      xbase   lambda         p   gammaMu gammaDis          V1
##     1:     1  3.5795510 2.358333 0.2837096  3.373363        1   6.7983438
##     2:     2  2.4815923 2.113107 0.2217457  2.708293        1   0.2476109
##     3:     3  3.6814643 2.382491 0.2899636  3.442827        1   5.1654530
##     4:     4  5.5136005 2.861540 0.4143722  4.966523        1   1.8236155
##     5:     5  0.6139601 1.753118 0.1399372  1.864125        1   0.9560088
##    ---                                                                   
##  9996:  9996  8.0718982 3.695773 0.6038587  8.284445        1   6.0392747
##  9997:  9997  5.1469824 2.758531 0.3879577  4.615391        1   0.1523506
##  9998:  9998 11.5464949 5.231246 0.8121358 16.598278        1 116.7283562
##  9999:  9999  1.5727854 1.929534 0.1782624  2.258175        1   0.7447944
## 10000: 10000  4.9227111 2.697354 0.3721074  4.412945        1   1.3250641
##                V2         V3         V4
##     1:  4.5669378  3.8504948  5.2271651
##     2:  0.5453362  0.4460928  3.0099483
##     3:  2.0426212  4.6233408  2.5924763
##     4:  1.1423568  1.1795282  0.9894915
##     5:  0.9406751  1.4915802  0.7567339
##    ---                                 
##  9996:  1.6857274  1.5429134  5.8449264
##  9997:  0.0265122  0.2351352  0.3304804
##  9998: 68.8185265 65.7342927 23.5237461
##  9999:  2.1871324 11.7884377  0.5797178
## 10000:  3.4906541  4.5999383  2.8119121</code></pre>
<p>If we have data in <em>long</em> form (e.g. longitudinal data), the function will recognize the structure:</p>
<pre class="r"><code>def &lt;- defData(varname = &quot;xbase&quot;, formula = 5, variance = .4, dist = &quot;gamma&quot;, id = &quot;cid&quot;)
def &lt;- defData(def, &quot;nperiods&quot;, formula = 3, dist = &quot;noZeroPoisson&quot;)

def2 &lt;- defDataAdd(varname = &quot;lambda&quot;, formula = &quot;.5+.5*period + .1*xbase&quot;, dist=&quot;nonrandom&quot;, link = &quot;log&quot;)

dt &lt;- genData(1000, def)

dtLong &lt;- addPeriods(dt, idvars = &quot;cid&quot;, nPeriods = 3)
dtLong &lt;- addColumns(def2, dtLong)

dtLong</code></pre>
<pre><code>##        cid period    xbase nperiods timeID   lambda
##    1:    1      0 1.950150        3      1 2.003739
##    2:    1      1 1.950150        3      2 3.303607
##    3:    1      2 1.950150        3      3 5.446728
##    4:    2      0 2.579262        1      4 2.133847
##    5:    2      1 2.579262        1      5 3.518118
##   ---                                              
## 2996:  999      1 3.241351        3   2996 3.758933
## 2997:  999      2 3.241351        3   2997 6.197432
## 2998: 1000      0 5.676698        2   2998 2.908594
## 2999: 1000      1 5.676698        2   2999 4.795461
## 3000: 1000      2 5.676698        2   3000 7.906378</code></pre>
<pre class="r"><code>### Generate the data 

dtX3 &lt;- addCorGen(dtOld = dtLong, idvar = &quot;cid&quot;, nvars = 3, rho = .6, corstr = &quot;cs&quot;,
                  dist = &quot;poisson&quot;, param1 = &quot;lambda&quot;, cnames = &quot;NewPois&quot;)
dtX3</code></pre>
<pre><code>##        cid period    xbase nperiods timeID   lambda NewPois
##    1:    1      0 1.950150        3      1 2.003739       3
##    2:    1      1 1.950150        3      2 3.303607       3
##    3:    1      2 1.950150        3      3 5.446728       6
##    4:    2      0 2.579262        1      4 2.133847       3
##    5:    2      1 2.579262        1      5 3.518118       8
##   ---                                                      
## 2996:  999      1 3.241351        3   2996 3.758933       5
## 2997:  999      2 3.241351        3   2997 6.197432       6
## 2998: 1000      0 5.676698        2   2998 2.908594       1
## 2999: 1000      1 5.676698        2   2999 4.795461       5
## 3000: 1000      2 5.676698        2   3000 7.906378       5</code></pre>
<p>We can fit a generalized estimating equation (GEE) model and examine the coefficients and the working correlation matrix. They match closely to the data generating parameters:</p>
<pre class="r"><code>geefit &lt;- gee(NewPois ~ period + xbase, data = dtX3, id = cid, family = poisson, corstr = &quot;exchangeable&quot;)</code></pre>
<pre><code>## Beginning Cgee S-function, @(#) geeformula.q 4.13 98/01/27</code></pre>
<pre><code>## running glm to get initial regression estimate</code></pre>
<pre><code>## (Intercept)      period       xbase 
##  0.52475840  0.50012769  0.09645326</code></pre>
<pre class="r"><code>round(summary(geefit)$working.correlation, 2)</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,] 1.00 0.58 0.58
## [2,] 0.58 1.00 0.58
## [3,] 0.58 0.58 1.00</code></pre>
</div>
</div>
