---
comments: false
---



<div id="generating-the-treatmentexposure" class="section level2">
<h2>Generating the treatment/exposure</h2>
<p>Treatment assignment can be accomplished through the original data generation process, using <code>defData</code> and <code>genData</code>. However, the functions <code>trtAssign</code> and <code>trtObserve</code> provide more options to generate treatment assignment.</p>
<div id="assigned-treatment" class="section level3">
<h3>Assigned treatment</h3>
<p>Treatment assignment can simulate how treatment is made in a randomized study. Assignment to treatment groups can be (close to) balanced (as would occur in a block randomized trial); this balancing can be done without or without strata. Alternatively, the assignment can be left to chance without blocking; in this case, balance across treatment groups is not guaranteed, particularly with small sample sizes.</p>
<p>First, create the data definition:</p>
<pre class="r"><code>def &lt;- defData(varname = &quot;male&quot;, dist = &quot;binary&quot;, 
               formula = .5 , id=&quot;cid&quot;)
def &lt;- defData(def, varname = &quot;over65&quot;, dist = &quot;binary&quot;, 
               formula = &quot;-1.7 + .8*male&quot;, link=&quot;logit&quot;)
def &lt;- defData(def, varname = &quot;baseDBP&quot;, dist = &quot;normal&quot;, 
               formula = 70, variance = 40)

dtstudy &lt;- genData(330, def)</code></pre>
<p><em>Balanced treatment assignment, stratified by gender and age category (not blood pressure)</em></p>
<pre class="r"><code>study1 &lt;- trtAssign(dtstudy, n = 3, balanced = TRUE, strata = c(&quot;male&quot;, &quot;over65&quot;), 
    grpName = &quot;rxGrp&quot;)

study1</code></pre>
<pre><code>##      cid rxGrp male over65  baseDBP
##   1:   1     1    1      0 71.69487
##   2:   2     3    1      1 67.40463
##   3:   3     3    1      0 72.84561
##   4:   4     2    0      0 60.99359
##   5:   5     2    0      0 69.58766
##  ---                               
## 326: 326     1    1      0 64.30698
## 327: 327     3    1      0 69.27226
## 328: 328     3    0      0 64.91889
## 329: 329     1    0      0 76.56930
## 330: 330     3    0      0 73.64229</code></pre>
<p><em>Balanced treatment assignment (without stratification)</em></p>
<pre class="r"><code>study2 &lt;- trtAssign(dtstudy, n = 3, balanced = TRUE, grpName = &quot;rxGrp&quot;)</code></pre>
<p><em>Random (unbalanced) treatment assignment</em></p>
<pre class="r"><code>study3 &lt;- trtAssign(dtstudy, n = 3, balanced = FALSE, grpName = &quot;rxGrp&quot;)</code></pre>
<p><em>Comparison of three treatment assignment mechanisms</em>
<img src="/page/treat_and_exposure_files/figure-html/unnamed-chunk-6-1.png" width="384" /></p>
</div>
<div id="observed-treatment" class="section level3">
<h3>Observed treatment</h3>
<p>If exposure or treatment is observed (rather than randomly assigned), use <code>trtObserved</code> to generate groups. There may be any number of possible exposure or treatment groups, and the probability of exposure to a specific level can depend on covariates already in the data set. In this case, there are three exposure groups that vary by gender and age:</p>
<pre class="r"><code>formula1 &lt;- c(&quot;-2 + 2*male - .5*over65&quot;, &quot;-1 + 2*male + .5*over65&quot;)
dtExp &lt;- trtObserve(dtstudy, formulas = formula1, logit.link = TRUE, grpName = &quot;exposure&quot;)</code></pre>
<p>Here are the exposure distributions by gender and age:</p>
<p><img src="/page/treat_and_exposure_files/figure-html/unnamed-chunk-8-1.png" width="624" /></p>
<p>Here is a second case of three exposures where the exposure is independent of any covariates. Note that specifying the formula as <code>c(.35, .45)</code> is the same as specifying it is <code>c(.35, .45, .20)</code>. Also, when referring to probabilities, the identity link is used:</p>
<pre class="r"><code>formula2 &lt;- c(0.35, 0.45)

dtExp2 &lt;- trtObserve(dtstudy, formulas = formula2, logit.link = FALSE, grpName = &quot;exposure&quot;)</code></pre>
<p><img src="/page/treat_and_exposure_files/figure-html/unnamed-chunk-10-1.png" width="624" /></p>
</div>
<div id="stepped-wedge-design" class="section level3">
<h3>Stepped-wedge design</h3>
<p>Stepped-wedge designs are a special class of cluster randomized trial where each cluster is observed in both treatment arms (as opposed to the classic parallel design where only some of the clusters receive the treatment). This is a special case of a cross-over design, where the cross-over is only in one direction: control (or pre-intervention) to intervention.</p>
<p>In this example, the data generating process looks like this:</p>
<p><span class="math display">\[Y_{ict} = \beta_0 + b_c + \beta_1 * t + \beta_2*X_{ct} + e_{ict}\]</span></p>
<p>where <span class="math inline">\(Y_{ict}\)</span> is the outcome for individual <span class="math inline">\(i\)</span> in cluster <span class="math inline">\(c\)</span> in time period <span class="math inline">\(t\)</span>, <span class="math inline">\(b_c\)</span> is a cluster-specific effect, <span class="math inline">\(X_{ct}\)</span> is the intervention indicator that has a value 1 during periods where the cluster is under the intervention, and <span class="math inline">\(e_{ict}\)</span> is the individual-level effect. Both <span class="math inline">\(b_c\)</span> and <span class="math inline">\(e_{ict}\)</span> are normally distributed with mean 0 and variances <span class="math inline">\(\sigma^2_{b}\)</span> and <span class="math inline">\(\sigma^2_{e}\)</span>, respectively. <span class="math inline">\(\beta_1\)</span> is the time trend, and <span class="math inline">\(\beta_2\)</span> is the intervention effect.</p>
<p>We need to define the cluster-level variables (i.e.Â the cluster effect and the cluster size) as well as the individual specific outcome. In this case each cluster will have 15 individuals per period, and <span class="math inline">\(\sigma^2_b = 0.20\)</span>. In addition, <span class="math inline">\(\sigma^2_e = 1.75\)</span>.</p>
<pre class="r"><code>library(simstudy)
library(ggplot2)

defc &lt;- defData(varname = &quot;ceffect&quot;, formula = 0, variance = 0.20, 
                dist = &quot;normal&quot;, id = &quot;cluster&quot;)
defc &lt;- defData(defc, &quot;m&quot;, formula = 15, dist = &quot;nonrandom&quot;)

defa &lt;- defDataAdd(varname = &quot;Y&quot;, 
                   formula = &quot;0 + ceffect + 0.1*period + trt*1.5&quot;, 
                   variance = 1.75, dist = &quot;normal&quot;)</code></pre>
<p>In this case, there will be 30 clusters and 24 time periods. With 15 individuals per cluster per period, there will be 360 observations for each cluster, and 10,800 in total. (There is no reason the cluster sizes need to be deterministic, but I just did that to simplify things a bit.)</p>
<p>Cluster-level intervention assignment is done after generating the cluster-level and time-period data. The call to <code>trtStepWedge</code> includes 3 key arguments that specify the number of waves, the length of each wave, and the period during which the first clusters begin the intervention.</p>
<p><code>nWaves</code> indicates how many clusters share the same starting period for the intervention. In this case, we have 5 waves, with 6 clusters each. <code>startPer</code> is the first period of the first wave. The earliest starting period is 0, the first period. Here, the first wave starts the intervention during period 4. <code>lenWaves</code> indicates the length between starting points for each wave. Here, a length of 4 means that the starting points will be 4, 8, 12, 16, and 20.</p>
<p>Once the treatment assignments are made, the individual records are created and the outcome data are generated in the last step.</p>
<pre class="r"><code>set.seed(608477)

dc &lt;- genData(30, defc)
dp &lt;- addPeriods(dc, 24, &quot;cluster&quot;, timevarName = &quot;t&quot;)
dp &lt;- trtStepWedge(dp, &quot;cluster&quot;, nWaves = 5, lenWaves = 4, 
          startPer = 4, grpName = &quot;trt&quot;)

dd &lt;- genCluster(dp, cLevelVar = &quot;timeID&quot;, &quot;m&quot;, &quot;id&quot;)
dd &lt;- addColumns(defa, dd)

dd</code></pre>
<pre><code>##        cluster period     ceffect  m timeID startTrt trt    id          Y
##     1:       1      0  0.62775229 15      1        4   0     1  1.5236098
##     2:       1      0  0.62775229 15      1        4   0     2  0.9863920
##     3:       1      0  0.62775229 15      1        4   0     3 -0.1232112
##     4:       1      0  0.62775229 15      1        4   0     4  2.0901759
##     5:       1      0  0.62775229 15      1        4   0     5 -2.3404034
##    ---                                                                   
## 10796:      30     23 -0.09828129 15    720       20   1 10796  1.9167998
## 10797:      30     23 -0.09828129 15    720       20   1 10797  5.9206722
## 10798:      30     23 -0.09828129 15    720       20   1 10798  4.1182178
## 10799:      30     23 -0.09828129 15    720       20   1 10799  4.5691583
## 10800:      30     23 -0.09828129 15    720       20   1 10800  3.6557608</code></pre>
<pre class="r"><code>dSum &lt;- dd[, .(Y = mean(Y)), keyby = .(cluster, period, trt, startTrt)]

ggplot(data = dSum, 
    aes(x = period, y = Y, group = interaction(cluster, trt))) +
  geom_line(aes(color = factor(trt))) +
  facet_grid(factor(startTrt, labels = c(1 : 5)) ~ .) +
  scale_x_continuous(breaks = seq(0, 23, by = 4), name = &quot;week&quot;) +
  scale_color_manual(values = c(&quot;#b8cce4&quot;, &quot;#4e81ba&quot;)) +
  theme(panel.grid = element_blank(),
        legend.position = &quot;none&quot;) </code></pre>
<p><img src="/page/treat_and_exposure_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>
</div>
