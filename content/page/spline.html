---
comments: FALSE
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="spline-data" class="section level2">
<h2>Spline data</h2>
<p>Sometimes (usually?) relationships between variables are non-linear. <code>simstudy</code> can already accommodate that. But, if we want to explicitly generate data from a piece-wise polynomial function to explore spline methods in particular, or non-linear relationships more generally. There are three functions that facilitate this: <code>viewBasis</code>, <code>viewSplines</code>, and <code>genSpline</code>. The first two functions are more exploratory in nature, and just provide plots of the B-spline basis functions and the splines, respectively. The third function actually generates data and adds to an existing data.table.</p>
<p>The shape of a spline is determined by three factors: (1) the cut-points or knots that define the piecewise structure of the function, (2) the polynomial degree, such as linear, quadratic, cubic, etc., and (3) the linear coefficients that combine the basis functions, which is contained in a vector or matrix <em>theta</em>.</p>
<p>First, we can look at the basis functions, which depend only the knots and degree. The knots are specified as quantiles, between 0 and 1:</p>
<pre class="r"><code>knots &lt;- c(0.25, 0.50, 0.75)
viewBasis(knots, degree = 2)</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-2-1.png" width="576" /></p>
<pre class="r"><code>knots &lt;- c(0.20, 0.40, 0.60, 0.80)
viewBasis(knots, degree = 3)</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-2-2.png" width="576" /></p>
<p>The splines themselves are specified as linear combinations of each of the basis functions. The coefficients of those combinations are specified in <em>theta</em>. Each individual spline curve represents a specific linear combination of a particular set of basis functions. In exploring, we can look at a single curve or multiple curves, depending on whether or not we specify theta as a vector (single) or matrix (multiple).</p>
<pre class="r"><code>knots &lt;- c(0.25, 0.5, 0.75)

# number of elements in theta: length(knots) + degree + 1
theta1 = c(0.1, 0.8, 0.4, 0.9, 0.2, 1.0) 

viewSplines(knots, degree = 2, theta1)</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-3-1.png" width="576" /></p>
<pre class="r"><code>theta2 = matrix(c(0.1, 0.2, 0.4, 0.9, 0.2, 0.3, 0.6, 
                  0.1, 0.3, 0.3, 0.8, 1.0, 0.9, 0.4, 
                  0.1, 0.9, 0.8, 0.2, 0.1, 0.6, 0.1),
               ncol = 3)

theta2</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]  0.1  0.1  0.1
## [2,]  0.2  0.3  0.9
## [3,]  0.4  0.3  0.8
## [4,]  0.9  0.8  0.2
## [5,]  0.2  1.0  0.1
## [6,]  0.3  0.9  0.6
## [7,]  0.6  0.4  0.1</code></pre>
<pre class="r"><code>viewSplines(knots, degree = 3, theta2)</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-3-2.png" width="576" /></p>
<p>We can generate data using a predictor in an existing data set by specifying the <em>knots</em> (in terms of quantiles), a vector of coefficients in <em>theta</em>, the degree of polynomial, as well as a range</p>
<pre class="r"><code>ddef &lt;- defData(varname = &quot;age&quot;, formula = &quot;20;60&quot;, dist = &quot;uniform&quot;)

theta1 = c(0.1, 0.8, 0.6, 0.4, 0.6, 0.9, 0.9)
knots &lt;- c(0.25, 0.5, 0.75)</code></pre>
<p>Here is the shape of the curve that we want to generate data from:</p>
<pre class="r"><code>viewSplines(knots = knots, theta = theta1, degree = 3)</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-5-1.png" width="576" /></p>
<p>Now we specify the variables in the data set and generate the data:</p>
<pre class="r"><code>set.seed(234)
dt &lt;- genData(1000, ddef)
dt &lt;- genSpline(dt = dt, newvar = &quot;weight&quot;,
                predictor = &quot;age&quot;, theta = theta1,
                knots = knots, degree = 3,
                newrange = &quot;90;160&quot;,
                noise.var = 64)</code></pre>
<p>Hereâ€™s a plot of the data with a smoothed line fit to the data:</p>
<pre class="r"><code>ggplot(data = dt, aes(x=age, y=weight)) +
  geom_point(color = &quot;grey65&quot;, size = 0.75) +
  geom_smooth(se=FALSE, color=&quot;red&quot;, size = 1, method = &quot;auto&quot;) +
  geom_vline(xintercept = quantile(dt$age, knots)) +
  theme(panel.grid.minor = element_blank())</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-7-1.png" width="576" /></p>
<p>Finally, we will fit three different spline models to the data - a linear, a quadratic, and a cubic - and plot the predicted values:</p>
<pre class="r"><code># normalize age for best basis functions
dt[, nage := (age - min(age))/(max(age) - min(age))] 

# fit a cubic spline
lmfit3 &lt;- lm(weight ~ bs(x = nage, knots = knots, degree = 3, intercept = TRUE) - 1, data = dt)

# fit a quadtratic spline
lmfit2 &lt;- lm(weight ~ bs(x = nage, knots = knots, degree = 2), data = dt)

# fit a  linear spline
lmfit1 &lt;- lm(weight ~ bs(x = nage, knots = knots, degree = 1), data = dt)

# add predicted values for plotting
dt[, pred.3deg := predict(lmfit3)]
dt[, pred.2deg := predict(lmfit2)]
dt[, pred.1deg := predict(lmfit1)]

ggplot(data = dt, aes(x=age, y=weight)) +
  geom_point(color = &quot;grey65&quot;, size = 0.75) +
  geom_line(aes(x=age, y = pred.3deg), color = &quot;#1B9E77&quot;, size = 1) +
  geom_line(aes(x=age, y = pred.2deg), color = &quot;#D95F02&quot;, size = 1) +
  geom_line(aes(x=age, y = pred.1deg), color = &quot;#7570B3&quot;, size = 1) +
  geom_vline(xintercept = quantile(dt$age, knots)) +
  theme(panel.grid.minor = element_blank())</code></pre>
<p><img src="/page/spline_files/figure-html/unnamed-chunk-8-1.png" width="576" /></p>
</div>
